<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spin Studio — Custom Wheel (Telegram Mini App Ready)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c3aed}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial;background:linear-gradient(180deg,#071426 0%, #07172a 100%);color:#e6eef8}
    .app{max-width:1000px;margin:18px auto;padding:18px;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .panel{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:18px}
    .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .wheel-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    canvas{border-radius:12px;background:transparent}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:white;font-weight:600;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;font-size:13px;margin-top:8px}
    input[type=text]{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .list{margin-top:10px;max-height:320px;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px}
    .item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px}
    .item .handle{cursor:grab;padding:6px}
    .color-swatch{width:28px;height:28px;border-radius:6px;border:1px solid rgba(0,0,0,0.2)}
    .small{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03)}
    .row{display:flex;gap:8px;align-items:center}
    .footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    .templates{display:flex;gap:8px;flex-wrap:wrap}
    .template{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;cursor:pointer}
    .share-area{display:flex;gap:8px;align-items:center;margin-top:10px}
    textarea{width:100%;height:80px;padding:8px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.05)}
    .top-right{display:flex;gap:8px;align-items:center}
    @media(max-width:880px){.panel{grid-template-columns:1fr;}.top{flex-direction:column;align-items:flex-start;gap:10px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <h1>Spin Studio — Custom Wheel (Free & Unlimited Spins)</h1>
      <div class="top-right muted">Built for Telegram Mini App • Works offline • Saved in browser</div>
    </div>

    <div class="panel">
      <!-- Left: Controls -->
      <div class="card">
        <div class="wheel-wrap">
          <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
            <div>
              <label>Wheel Label</label>
              <input id="wheelTitle" type="text" value="Spin & Fun" />
            </div>
            <div style="text-align:right">
              <label class="muted">Spins</label>
              <div id="spinCount" class="small">0</div>
            </div>
          </div>

          <canvas id="wheelCanvas" width="360" height="360"></canvas>

          <div style="display:flex;gap:8px;width:100%;justify-content:center">
            <button id="spinBtn">SPIN NOW</button>
            <button id="customizeBtn" class="small">Open Customize</button>
            <button id="exportBtn" class="small">Export JSON</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Result</div>
          <div id="result" style="margin-top:6px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)"></div>
        </div>

        <div class="footer">Unlimited free spins • All data saved locally in browser</div>
      </div>

      <!-- Right: Editor -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <label class="muted">Customize Wheel Sections</label>
            <div class="muted">Add / Edit / Remove / Reorder — changes save automatically</div>
          </div>
          <div style="text-align:right">
            <label class="muted">Templates</label>
            <div class="templates" id="templates">
              <!-- JS fills -->
            </div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <input id="newText" type="text" placeholder="New section text (e.g. "Joke")" />
          <input id="newColor" type="color" value="#ffb020" style="width:42px;height:38px;padding:2px;border-radius:6px;border:none;background:#fff"/>
          <button id="addBtn" class="small">Add</button>
        </div>

        <div class="list" id="sectionsList" aria-live="polite"></div>

        <div style="margin-top:10px">
          <label class="muted">Export / Import Wheel JSON (shareable)</label>
          <div class="share-area">
            <button id="saveToHash" class="small">Save to URL</button>
            <button id="clearBtn" class="small">Reset</button>
            <button id="downloadBtn" class="small">Download .json</button>
          </div>
          <textarea id="importExport" placeholder='Paste wheel JSON here to import or click Export JSON'></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportJSON" class="small">Export JSON</button>
            <button id="importJSON" class="small">Import JSON</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- Basic data model ---
    const defaultWheels = {
      "Fun Wheel": [
        {t:"Meme",c:'#ffb020'},
        {t:"Joke",c:'#ff6b6b'},
        {t:"Dare",c:'#7c3aed'},
        {t:"Quote",c:'#34d399'},
        {t:"Prediction",c:'#60a5fa'},
        {t:"Fun Fact",c:'#f472b6'},
        {t:"Mini Game",c:'#f59e0b'},
        {t:"Emoji",c:'#10b981'}
      ],
      "Truth/Dare": [
        {t:"Truth",c:'#60a5fa'},
        {t:"Dare",c:'#fb7185'},
        {t:"Double",c:'#f97316'},
        {t:"Skip",c:'#a78bfa'}
      ],
      "Motivation": [
        {t:"Tiny Tip",c:'#34d399'},
        {t:"Quote",c:'#60a5fa'},
        {t:"Push",c:'#7c3aed'},
        {t:"Breathe",c:'#93c5fd'}
      ]
    };

    const storageKey = 'spinstudio_v1';
    let wheel = {title:'Spin & Fun', sections: defaultWheels['Fun Wheel'].slice()};
    let spinCount = 0;

    // --- Elements ---
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const resultEl = document.getElementById('result');
    const sectionsList = document.getElementById('sectionsList');
    const wheelTitleEl = document.getElementById('wheelTitle');
    const addBtn = document.getElementById('addBtn');
    const newText = document.getElementById('newText');
    const newColor = document.getElementById('newColor');
    const spinCountEl = document.getElementById('spinCount');
    const exportJSONBtn = document.getElementById('exportJSON');
    const importJSONBtn = document.getElementById('importJSON');
    const importExportTA = document.getElementById('importExport');
    const saveToHashBtn = document.getElementById('saveToHash');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const templatesDiv = document.getElementById('templates');

    // --- Utilities ---
    function saveToStorage(){
      const blob = {wheel,spinCount};
      localStorage.setItem(storageKey,JSON.stringify(blob));
    }
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(storageKey);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && parsed.wheel) { wheel = parsed.wheel; spinCount = parsed.spinCount||0; }
        }
      }catch(e){console.warn('load err',e)}
    }

    function drawWheel(rotation=0){
      const w = canvas.width, h = canvas.height, cx=w/2, cy=h/2, r=Math.min(w,h)/2 - 6;
      ctx.clearRect(0,0,w,h);
      const n = Math.max(1,wheel.sections.length);
      const slice = (Math.PI*2)/n;
      for(let i=0;i<n;i++){
        const start = rotation + i*slice;
        const end = start + slice;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,end);
        ctx.closePath();
        ctx.fillStyle = wheel.sections[i].c || '#888';
        ctx.fill();
        // text
        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(start + slice/2);
        ctx.textAlign='right';
        ctx.fillStyle = '#061122';
        ctx.font = 'bold 14px sans-serif';
        wrapText(ctx,wheel.sections[i].t, r-12, 0, -10, 18);
        ctx.restore();
      }
      // center circle
      ctx.beginPath();ctx.arc(cx,cy,42,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fill();
      ctx.fillStyle='white';ctx.font='bold 16px sans-serif';ctx.textAlign='center';ctx.fillText(wheel.title || 'Spin',cx,cy+6);
      // draw pointer
      ctx.beginPath();ctx.moveTo(w-18,cy);ctx.lineTo(w-6,cy-12);ctx.lineTo(w-6,cy+12);ctx.closePath();ctx.fillStyle='#fffb';ctx.fill();
    }

    function wrapText(ctx, text, maxWidth, x, y, lineHeight){
      const words = text.split(' ');
      let line=''; let ty = y;
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && n>0){
          ctx.fillText(line, x, ty);
          line = words[n] + ' ';
          ty += lineHeight;
        } else { line = testLine; }
      }
      ctx.fillText(line, x, ty);
    }

    // --- Spin logic ---
    let spinning=false;
    async function spin(){
      if(spinning) return;
      spinning=true; resultEl.textContent='';
      const n = wheel.sections.length;
      // choose random index with bias optional
      const chosenIndex = Math.floor(Math.random()*n);
      // calculate final rotation so pointer lands on chosenIndex
      const slice = (Math.PI*2)/n;
      const finalAngle = (Math.PI*2)* (4 + Math.random()*2) + (Math.PI/2) - (chosenIndex+0.5)*slice; // multiple spins
      const duration = 3200 + Math.random()*1200;
      const start = performance.now();
      function animate(t){
        const p = Math.min(1,(t-start)/duration);
        const ease = 1 - Math.pow(1-p,3);
        drawWheel(ease*finalAngle);
        if(p<1) requestAnimationFrame(animate); else finish();
      }
      function finish(){
        spinning=false; spinCount++; spinCountEl.textContent=spinCount; saveToStorage();
        const sec = wheel.sections[chosenIndex];
        showResult(sec);
      }
      requestAnimationFrame(animate);
    }

    function showResult(sec){
      // Rich display: image if text starts with img:, else text
      if(!sec) return;
      if(sec.t.startsWith('img:')){
        const url = sec.t.slice(4);
        resultEl.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:8px"/>`;
      } else {
        resultEl.textContent = sec.t;
      }
    }

    // --- Editor UI ---
    function renderList(){
      sectionsList.innerHTML='';
      wheel.sections.forEach((s,idx)=>{
        const div = document.createElement('div'); div.className='item'; div.draggable=true; div.dataset.index=idx;
        const handle = document.createElement('div'); handle.className='handle muted'; handle.innerText='↕';
        const sw = document.createElement('div'); sw.className='color-swatch'; sw.style.background=s.c;
        const t = document.createElement('input'); t.type='text'; t.value=s.t; t.style.flex='1'; t.style.background='transparent'; t.style.color='inherit'; t.oninput = e=>{ wheel.sections[idx].t = e.target.value; saveToStorage(); drawWheel(); }
        const color = document.createElement('input'); color.type='color'; color.value = s.c || '#ffb020'; color.oninput = e=>{ wheel.sections[idx].c=e.target.value; sw.style.background=e.target.value; saveToStorage(); drawWheel(); }
        const del = document.createElement('button'); del.className='small'; del.innerText='Delete'; del.onclick = ()=>{ wheel.sections.splice(idx,1); saveToStorage(); renderList(); drawWheel(); }
        div.appendChild(handle); div.appendChild(sw); div.appendChild(t); div.appendChild(color); div.appendChild(del);
        // drag events
        div.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', idx); div.style.opacity='0.4'; });
        div.addEventListener('dragend', ev=>{ div.style.opacity='1'; });
        div.addEventListener('dragover', ev=>{ ev.preventDefault(); });
        div.addEventListener('drop', ev=>{
          ev.preventDefault(); const from = parseInt(ev.dataTransfer.getData('text/plain')); const to = parseInt(div.dataset.index);
          if(from!==to){ const item = wheel.sections.splice(from,1)[0]; wheel.sections.splice(to,0,item); saveToStorage(); renderList(); drawWheel(); }
        });
        sectionsList.appendChild(div);
      });
    }

    addBtn.onclick = ()=>{
      const text = newText.value.trim() || 'New'; const color = newColor.value;
      wheel.sections.push({t:text,c:color}); newText.value=''; saveToStorage(); renderList(); drawWheel();
    }

    exportJSONBtn.onclick = ()=>{
      const payload = JSON.stringify(wheel,null,2); importExportTA.value = payload; navigator.clipboard?.writeText(payload).catch(()=>{});
    }
    importJSONBtn.onclick = ()=>{
      try{ const parsed = JSON.parse(importExportTA.value); if(parsed && parsed.sections){ wheel = parsed; saveToStorage(); renderList(); drawWheel(); alert('Imported wheel'); } else alert('Invalid wheel JSON'); }
      catch(e){ alert('Invalid JSON'); }
    }

    saveToHashBtn.onclick = ()=>{
      const payload = btoa(unescape(encodeURIComponent(JSON.stringify(wheel))));
      const url = location.origin + location.pathname + '#wheel=' + payload;
      navigator.clipboard?.writeText(url).catch(()=>{});
      prompt('Shareable URL (copied to clipboard):', url);
    }
    clearBtn.onclick = ()=>{ if(confirm('Reset to default wheel?')){ wheel = {title:'Spin & Fun', sections: defaultWheels['Fun Wheel'].slice()}; spinCount=0; saveToStorage(); renderList(); drawWheel(); } }
    downloadBtn.onclick = ()=>{ const data = JSON.stringify(wheel,null,2); const blob = new Blob([data],{type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='wheel.json'; a.click(); }

    exportJSONBtn.addEventListener('click', ()=>{ exportJSONBtn.disabled=true; setTimeout(()=>exportJSONBtn.disabled=false,800); });

    document.getElementById('customizeBtn').addEventListener('click', ()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); document.getElementById('newText').focus(); });

    // import from URL hash
    function tryLoadFromHash(){
      const h = location.hash || '';
      if(h.startsWith('#wheel=')){ try{ const b64 = h.split('=')[1]; const json = decodeURIComponent(escape(atob(b64))); const parsed = JSON.parse(json); if(parsed && parsed.sections){ wheel = parsed; saveToStorage(); renderList(); drawWheel(); return true; } }catch(e){} }
      return false;
    }

    // templates
    function renderTemplates(){
      templatesDiv.innerHTML=''; for(const k in defaultWheels){ const btn = document.createElement('div'); btn.className='template'; btn.innerText=k; btn.onclick = ()=>{ if(confirm('Load template "'+k+'"? This will replace current wheel.')){ wheel.sections = defaultWheels[k].slice(); wheel.title = k; saveToStorage(); renderList(); drawWheel(); } }; templatesDiv.appendChild(btn); }
    }

    // load and init
    function init(){
      loadFromStorage(); const loadedFromHash = tryLoadFromHash(); renderTemplates(); renderList(); wheelTitleEl.value = wheel.title || 'Spin & Fun'; drawWheel(); spinCountEl.textContent = spinCount;
      wheelTitleEl.oninput = ()=>{ wheel.title = wheelTitleEl.value; saveToStorage(); drawWheel(); }
    }

    spinBtn.addEventListener('click', spin);

    // keyboard space to spin
    window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); spin(); } });

    // import JSON from textarea on load if present
    init();

    // attempt Telegram WebApp integration (if running inside Telegram)
    try{
      if(window.Telegram && window.Telegram.WebApp){
        const tg = window.Telegram.WebApp;
        tg.init();
        // set main button text (if you want)
        if(tg.MainButton) tg.MainButton.setText('Open').show();
      }
    }catch(e){/*ignore*/}

    // expose for debugging
    window.spinStudio = {wheel,drawWheel,spin};
  </script>
</body>
</html>
